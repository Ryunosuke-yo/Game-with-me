
import Head from 'next/head'
import Header from '../componets/Header'
import Inputforsearch from '../componets/InputForSearch'
import {signIn, useSession, signOut} from "next-auth/react"
import SignUpForm from '../componets/signUpForm'
import { SignOut, SignIn } from '../componets/signInOut'
import { Center, Text, VStack } from '@chakra-ui/react'
import SignedInSuc from '../componets/signedInSuc'
import { createContext, useCallback, useEffect } from 'react'
import {connectMongoose, myModel} from "../lib/mongodb"
import Users from '../componets/userSearch/users'
import { useState } from 'react'
import {getSession} from "next-auth/react"



export default function Home({user}) {
  const {data : session , status} = useSession()
  const [searchedUser, setSearchedUser] = useState(null)
  const [userData, setUserData] =useState()


  useEffect(()=>{
    const loginFilterUsers = userData?.filter(u=>u.email != session?.user.email)
    setSearchedUser(loginFilterUsers)
    setUserData(loginFilterUsers)
    console.log(session)
  }, [session])
    
    const renderUsers = searchedUser ?  searchedUser.map(u=>
      <Users u = {u}/>
      ) : 
      null
      
      
      useEffect(()=>{
        setUserData(session ? user.filter(u=>u.email != session?.user.email) : user)
        setSearchedUser(user.filter(u=>u.email != session?.user.email))
      },[])


    
  const handleNameInput = e =>{

            const filtered = userData.filter(user=>{
            const isGamesIncludes = user.games.some((game)=>game.includes(e.target.value))
            
            return isGamesIncludes ? user : user.name.includes(e.target.value)
            })
            console.log(searchedUser)
            setSearchedUser(filtered)
        }


  return (
    <>
      <Head>
        <title>Profile</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main>
        <Header loggedIn={session}/>
        {session ? <SignedInSuc name={session.user.name} /> : 
        <>
        <SignUpForm />
        <SignIn />
        </>
        }
        <Inputforsearch handleNameInput={handleNameInput}/>
        <Center mb="2rem">
          <VStack>
              {renderUsers}
          </VStack>
        </Center>
      </main>
      </>
  )
}

export async function getServerSideProps() {
  await connectMongoose()
  console.log("fetched")
  
  const findUsers = await myModel.find({})
  return {
            props : {
                user : JSON.parse(JSON.stringify(findUsers))
            }
        }
} 